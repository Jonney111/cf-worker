name: Sync single file from upstream

on:
  schedule:
    - cron: "0 */6 * * *"  # æ¯ 6 å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync-json:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Checkout fork
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # 2ï¸âƒ£ Add upstream and fetch
      - name: Add upstream
        run: |
          git remote add upstream https://github.com/byJoey/cfnew.git
          git fetch upstream

      # 3ï¸âƒ£ Determine upstream default branch
      - name: Get upstream default branch
        id: branch
        run: |
          UPSTREAM_BRANCH=$(git remote show upstream | grep "HEAD branch" | cut -d ":" -f2 | tr -d ' ')
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT

      # 4ï¸âƒ£ Checkout fork default branch
      - name: Checkout fork branch
        run: |
          git checkout -B main  # æ”¹æˆ master å¦‚æœä½ çš„ fork é»˜è®¤åˆ†æ”¯æ˜¯ master

      # 5ï¸âƒ£ Configure Git user for commit
      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # 6ï¸âƒ£ List upstream files (debug)
      - name: List upstream files
        run: |
          git ls-tree -r upstream/${{ steps.branch.outputs.upstream_branch }}

      # 7ï¸âƒ£ Attempt to fetch file (safe)
      - name: Fetch upstream file
        run: |
          mkdir -p tmp_upstream
          git --work-tree=tmp_upstream checkout upstream/${{ steps.branch.outputs.upstream_branch }} -- "å°‘å¹´ä½ ç›¸ä¿¡å…‰å—" || echo "Upstream file not found"
          ls tmp_upstream

      # 8ï¸âƒ£ Copy, rename, and commit if exists
      - name: Copy and commit file
        run: |
          if [ -f tmp_upstream/å°‘å¹´ä½ ç›¸ä¿¡å…‰å— ]; then
            cp tmp_upstream/å°‘å¹´ä½ ç›¸ä¿¡å…‰å— ./shaonian.json
            git add shaonian.json
            git commit -m "Update shaonian.json from upstream" || echo "No changes to commit"
          else
            echo "File not found, skipping commit"
          fi

      # 9ï¸âƒ£ Configure push using PAT
      - name: Configure push with PAT
        run: |
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/Jonney111/cf-vless.git

      # ğŸ”Ÿ Push changes
      - name: Push changes
        run: git push origin main
